<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>金十数据_财经资讯</title>
<script src="javascripts/jquery-1.9.1.min.js"></script>
<script src="javascripts/all.js"></script>
<link rel="stylesheet" href="/stylesheets/reset.css">
<link rel="stylesheet" href="/stylesheets/infor.css">
</head>
<body>
<!--top-->
<div class="top">
	<h1 class="tp_left">
    	<a href="javascript:;"><img src="images/logo.png" width="210" height="47"></a>
    </h1>
    <div class="tp_right">
    	<input class="tp_enter" placeholder="请输入关键词">
        <a class="tp_search" href="javascript:;"></a>
    </div>
</div>
<!--nav-->
<div class="nav">
	<ul>
        <li><a href="/">首页</a></li>
    	<li><a href="/strategy">独家策略</a></li> 
    	<li class="nv_bg2"><a href="/infor">财经资讯</a></li>
    	<li><a href="/calendar">财经日历</a></li> 
    	<li><a href="/market">实时行情</a></li>
    </ul>
</div>
<!--info-->
<div class="info">
    <div class="io_left">
        <dl id="news_box">
            <dt>
                <span class="io_topic">财经资讯</span>
                <!-- <ul class="io_category">
                    <li><a href="javascript:;">股市</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">原油</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">外汇</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">贵金属</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">国际形势</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">宏观</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">理财</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">央行</a>&nbsp;/&nbsp;</li>
                    <li><a href="javascript:;">投行</a></li>
                </ul> -->
            </dt>
        </dl>
        <div class="pagination" id="pagination" style="text-align: center"></div>
    </div>
    <div class="io_right">
        <dl class="io_flash" style="overflow:hidden;">
            <dt>
                <span>快讯</span>
                <a href="/">更多>></a>
            </dt>
            <div class="io_dd">
               <% for (var i = 0; i < newsList.length; i++) {%>
                    <dd>
                    <span class="io_time2"><%=newsList[i]["time"].substring(10,16)%></span>
                    <% if(newsList[i]["importance"]=="高") {%>
                    <p class="io_column io_cn_color"> <a href="javascript:;" style="cursor: default"><%-newsList[i]["title"] %></a></p>
                    <%}else{%>
                    <p class="io_column "> <a href="javascript:;" style="cursor: default"><%-newsList[i]["title"] %></a></p>
                    <%}%>
                    </dd>
               <%} %>
            </div>
        </dl>
        <dl class="io_flash">
            <dt>
                <span>行情</span>
                <a href="/market">更多>></a>
            </dt>
            <ul class="io_title">
            	<li><a class="io_te_check" href="javascript:;">股指</a></li>
            	<li><a href="javascript:;">贵金属</a></li>
            	<li><a href="javascript:;">商品</a></li>
            	<li><a href="javascript:;">外汇</a></li>
            </ul>
            <div class="io_dl">
                <dl class="io_list">
                    <%  for(var i=0; i<guzhiData.length; i++) { %>
                        <dd data-code="<%=guzhiData[i]["Code"] %>" class="<%=guzhiData[i]["Code"] %>">
                            <span title="<%=guzhiData[i]["Name"] %>"><%=guzhiData[i]["Name"] %></span>
                            <span title="<%=guzhiData[i]["Last"] %>"><%=guzhiData[i]["Last"] %></span>
                            <% if(shangpingData[i]["Swing"]*1<0){ %>
                            <span class="gr_" style="width:46%" title="<%=guzhiData[i]["Swing"] %> | <%=guzhiData[i]["SwingRange"] %>"><%=guzhiData[i]["Swing"] %> | <%=guzhiData[i]["SwingRange"] %></span>
                            <% }else{ %>
                            <span class="r_" style="width:46%" title="<%=guzhiData[i]["Swing"] %> | <%=guzhiData[i]["SwingRange"] %>"><%=guzhiData[i]["Swing"] %> | <%=guzhiData[i]["SwingRange"] %></span>
                            <% } %>
                        </dd>
                    <%}%>
                </dl>
                <dl class="io_list">
                    <%  for(var i=0; i<guijinshuData.length; i++) { %>
                        <dd data-code="<%=guijinshuData[i]["Code"] %>" class="<%=guijinshuData[i]["Code"] %>">
                            <span title="<%=guijinshuData[i]["Name"] %>"><%=guijinshuData[i]["Name"] %></span>
                            <span title="<%=guijinshuData[i]["Last"] %>"><%=guijinshuData[i]["Last"] %></span>
                             <% if(shangpingData[i]["Swing"]*1<0){ %>
                            <span class="gr_" style="width:46%" title="<%=guijinshuData[i]["Swing"] %> | <%=guijinshuData[i]["SwingRange"] %>"><%=guijinshuData[i]["Swing"] %> | <%=guijinshuData[i]["SwingRange"] %></span>
                            <% }else{ %>
                            <span class="r_" style="width:46%" title="<%=guijinshuData[i]["Swing"] %> | <%=guijinshuData[i]["SwingRange"] %>"><%=guijinshuData[i]["Swing"] %> | <%=guijinshuData[i]["SwingRange"] %></span>
                            <% } %>
                        </dd>
                    <%}%>       
                </dl>
                <dl class="io_list">
                    <%  for(var i=0; i<shangpingData.length; i++) { %>
                        <dd data-code="<%=shangpingData[i]["Code"] %>" class="<%=shangpingData[i]["Code"] %>">
                            <span title="<%=shangpingData[i]["Name"] %>"><%=shangpingData[i]["Name"] %></span>
                            <span title="<%=shangpingData[i]["Last"] %>"><%=shangpingData[i]["Last"] %></span>
                             <% if(shangpingData[i]["Swing"]*1<0){ %>
                            <span class="gr_" style="width:46%" title="<%=shangpingData[i]["Swing"] %> | <%=shangpingData[i]["SwingRange"] %>"><%=shangpingData[i]["Swing"] %> | <%=shangpingData[i]["SwingRange"] %></span>
                            <% }else{ %>
                            <span class="r_" style="width:46%" title="<%=shangpingData[i]["Swing"] %> | <%=shangpingData[i]["SwingRange"] %>"><%=shangpingData[i]["Swing"] %> | <%=shangpingData[i]["SwingRange"] %></span>
                            <% } %>
                        </dd>
                    <%}%>       
                </dl>
                <dl class="io_list">
                    <%  for(var i=0; i<waihuiData.length; i++) { %>
                        <dd data-code="<%=waihuiData[i]["Code"] %>" class="<%=waihuiData[i]["Code"] %>">
                            <span title="<%=waihuiData[i]["Name"] %>"><%=waihuiData[i]["Name"] %></span>
                            <span title="<%=waihuiData[i]["Last"] %>"><%=waihuiData[i]["Last"] %></span>
                             <% if(shangpingData[i]["Swing"]*1<0){ %>
                            <span class="gr_" style="width:46%" title="<%=waihuiData[i]["Swing"] %> | <%=waihuiData[i]["SwingRange"] %>"><%=waihuiData[i]["Swing"] %> | <%=waihuiData[i]["SwingRange"] %></span>
                            <% }else{ %>
                            <span class="r_" style="width:46%" title="<%=waihuiData[i]["Swing"] %> | <%=waihuiData[i]["SwingRange"] %>"><%=waihuiData[i]["Swing"] %> | <%=waihuiData[i]["SwingRange"] %></span>
                            <% } %>
                        </dd>
                    <%}%>
                </dl>
            </div>
        </dl>
    </div>
</div>
<hr style="height:1px;background-color:#dcdcdc;margin-bottom:24px;">
<!--footer-->
<div class="footer">
	<ul>
    	<li><a href="javascript:;">关于我们</a></li>
    	<li><a href="javascript:;">联系我们</a></li>
    	<li><a href="javascript:;">免责声明</a></li>
    	<li><a href="javascript:;">意见反馈</a></li>
    	<li><a href="javascript:;">网站地图</a></li>
    </ul>
    <p>Copyright &copy; 2001-2015 金十数据 DYHJW.com All Rights Reserved | 沪ICP备15014470号- 12 </p>
    <span class="fr_safe"></span>
</div>
    <script src="/javascripts/laypage/laypage.js"></script>
    <script type="text/javascript">
        function page_(currentPage){
        $.getJSON('/infor/'+currentPage+'/2', {
        page: currentPage || 1,
        catId:2
    }, function(res){
        console.log(res);
        //显示分页
        $("#news_box dd").remove();
        var articleList=res.articleList;
        for (var i = 0; i < articleList.length; i++) {
            var htmltr='<dd>\
                <a href="/desc/'+articleList[i].id+'" target="_blank">\
                    '+articleList[i]["img"].replace(/\%\$\%/g,"\"")+'\
                </a>\
                <div class="io_txt">\
                    <a href="/desc/'+articleList[i].id+'" target="_blank"><h1>'+articleList[i]["title"]+'</h1></a>\
                    <a href="javascript:;">\
                        <p>'+articleList[i]["summary"]+'</p>\
                    </a>\
                    <div class="io_desc">\
                        <span class="io_author"><em>文/admin</em></span>\
                        <span class="io_time">'+articleList[i]["time"]+'</span>\
                    </div>\
                </div>\
            </dd>';
            $("#news_box").append(htmltr);
        }
        laypage({
            cont: 'pagination', //容器。值支持id名、原生dom对象，jquery对象。【如该容器为】：<div id="page1"></div>
            pages: res.pages, //通过后台拿到的总页数
            curr: currentPage || 1, //当前页
            // skip: true, //是否开启跳页
            skin: '#AF0000',
            jump: function(obj, first){ //触发分页后的回调
                if(!first){ //点击跳页触发函数自身，并传递当前页：obj.curr
                    page_(obj.curr);
                }
            }
        });
    });
};
page_(1);
    </script>
<script type="text/javascript" src="/javascripts/swfobject.js"></script>
<script type="text/javascript" src="/javascripts/web_socket.js"></script>
<script type="text/javascript">
 WEB_SOCKET_SWF_LOCATION = "/javascripts/WebSocketMain.swf";
var code = new Array();
$(".io_list dd").each(function(){
    code.push( $(this).attr("data-code") );
});
var crypt=<%-oldtoken%>;
var codeStr = code;
</script>
<script type="text/javascript">
    var page=1;
    $(".io_more").click(function(){
        page++;
        $.ajax({
            url: '/infor/getMore?page='+page,
            type: 'get',
            success:function(htmlStr){

                $(".io_left dd").append(htmlStr);
            }
        })
    })



    var wsReconnect = function() {
    this.ws = null;
    this.timeInterval;
    var local = this;
    this.debug = true;
    this.dataHqLoginString = 'ws://114.215.194.79:8181/';
    //this.loginS = codeStr
    this.log = function(msg) {
        if (this.debug) {
        }
    }
    this.sendHeartbeat = function() {
        msg = new Object();
        msg.cmd = 'heartbeat';
        msg.data = ""
            //local.log(local.ws)
        try {
            local.connect();
            local.ws.send(JSON.stringify(msg));
        } catch (e) {
            local.log(e.name + ": " + e.message);
        }
        //local.log("sendHeartbeat");
    }
    this.listenEvent = function() {
        /**
         * 连接建立时触发
         */
        local.ws.onopen = function(e) {
            //连接成功
            //local.log("connect webim server success.");
            //发送登录信息
            //local.reLogin();
        };
        //有消息到来时触发
        local.ws.onmessage = function(e) {
            var data = JSON.parse(e.data);
            console.log(data);
            updateNews(data);
        };
        /**
         * 连接关闭事件
         */
        local.ws.onclose = function(e) {
            //local.log("onclose:" + e);
            //local.log("clearInterval:" + local.timeInterval);
            //clearInterval(timeInterval);
            //
            //                setTimeout(function(){
            //                    var wsr = new wsReconnect();
            //                    wsr.connect();
            //                },1000*5);
        };
        /**
         * 异常事件
         */
        local.ws.onerror = function(e) {
            //alert("异常:" + e.data);
            local.log("onerror" + e);
            //                local.timeInterval = setTimeout(function(){
            //                        local.sendHeartbeat();
            //                },1000*60);
        };
    }
    this.connect = function(type) {
        // document.cookie = "";
        //local.log("connect");
        $.get("http://1.nageren.sinaapp.com/fun.php?v=" + Math.round(new Date().getTime() / 1000), function(data, status) {
            if (data !== 0) {
                // setCookie("hqToken", data);
               if (typeof local.ws == "undefined" || local.ws == null || local.ws.readyState == 2 || local.ws.readyState == 3) {
                    if (window.WebSocket || window.MozWebSocket) {
                        local.ws = new WebSocket(local.dataHqLoginString + type + "?token=" + data);
                        local.listenEvent();
                    } else if (1) {
                        WEB_SOCKET_SWF_LOCATION = "/javascripts/WebSocketMain.swf?v=" + Math.round(new Date().getTime() / 1000);
                        $.getScript("/javascripts/swfobject.js", function() {
                            $.getScript("/javascripts/web_socket.js", function() {
                                local.ws = new WebSocket(local.dataHqLoginString + type + "?token=" + data);
                                local.listenEvent();
                            });
                        });
                    }
                }
            }
        });
    }
}
function updateNews(json)
{
    $(".io_dd dd:last").remove();
    var str='<dd><span class="io_time2">'+json["time"].substr(10,6)+'</span>';
    if(json['importance']=="高")
        str+='<p class="io_column io_cn_color"><a href="javascript:;" style="cursor: default">'+json["title"]+'</a></p></dd>';
    else
        str+='<p class="io_column"><a href="javascript:;" style="cursor: default">'+json["title"]+'</a></p></dd>';
}
var wsr = new wsReconnect();
wsr.connect("connectNews");



var wsServer = "ws://114.215.194.241:9504";
    var websocket = new WebSocket(wsServer);
    websocket.onopen = function(evt) {
        var msg = {
            'type': 'client',
            'code': codeStr,
            'crypt': crypt
        };

        var jsonmsg = JSON.stringify(msg);
        websocket.send(jsonmsg);
    };

    websocket.onclose = function(evt) {
        // var data = JSON.parse(evt.data);
        // console.log(data);
    };

    websocket.onmessage = function(evt) {
        try {
            var data = JSON.parse(evt.data);
        } catch (error) {
            layer.close(Loading);
            return false;
        }
        if(typeof(data.ok)!="number")
        upData(data);
       

        // layer.close(Loading);
    };

    websocket.onerror = function(evt, e) {
    };


  


function upData(data) {
    var ele1 = $(" ." + data.code + ' span:eq(1)');
    var ele2 = $(" ." + data.code + ' span:eq(2)');
    ele2.removeClass('gr_');
    ele2.removeClass('r_');
    var v = getZd(data.last, data.lastClose);
    var zd = v[0];
    var zdf = v[1];
    var n = "";
    if (zd < 0) {
        flashColor(ele2, 'green');
        ele2.addClass('gr_');
    } else if (zd > 0) {
        flashColor(ele2, 'red');
        ele2.addClass('r_');
        n = "+";
    }
    ele1.text(data.last);
    ele2.text(data.swing+" | "+data.swingRange);
}

function getZd(p, lc) {
    p = p.toString();
    lc = lc.toString();
    var len1 = p.indexOf(".");
    if (len1 > -1) {
        len1 = p.substring(len1 + 1).length;
    } else {
        len1 = 0;
    }
    var len2 = lc.indexOf(".");
    if (len2 > -1) {
        len2 = lc.substring(len2 + 1).length;
    } else {
        len2 = 0;
    }
    var len = len2;
    if (len1 >= len2) {
        len = len1;
    }
    var num = Math.pow(10, len);
    var zd = (p * num - lc * num) / num;
    zd = zd.toFixed(len);

    var zdf = ((zd * num) / (lc * num)) * 100;
    zdf = zdf.toFixed(2);
    var result = [zd, zdf];
    return result;
}


//更新数据闪亮一下
function flashColor(ele, color) {
    if (color == 'red') {
        ele.addClass('rbcolor');
        ele.addClass('w_');
        setTimeout(function() {
            ele.removeClass('rbcolor');
            ele.removeClass('w_');
        }, 500);
    } else if (color == 'green') {
        ele.addClass('gbcolor');
        ele.addClass('w_');
        setTimeout(function() {
            ele.removeClass('gbcolor');
            ele.removeClass('w_');
        }, 500);
    }
}
</script>
</body>
</html>
